{% extends 'base.html' %}

{% block title %}Shopping Cart - NaturalBio{% endblock %}
{% block meta_description %}Review your cart of natural herbs, tisanes and wellness products.{% endblock %}

{% block breadcrumb %}
<div class="bg-neutral-50 py-4">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <nav class="flex" aria-label="Breadcrumb">
            <ol class="flex items-center space-x-2 text-sm">
                <li><a href="/" class="text-neutral-500 hover:text-primary transition-colors">Home</a></li>
                <li class="text-neutral-400"><i class="fas fa-chevron-right text-xs"></i></li>
                <li><a href="/shop" class="text-neutral-500 hover:text-primary transition-colors">Shop</a></li>
                <li class="text-neutral-400"><i class="fas fa-chevron-right text-xs"></i></li>
                <li class="text-neutral-900 font-medium" aria-current="page">Shopping Cart</li>
            </ol>
        </nav>
    </div>
</div>
{% endblock %}
{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <h1 class="text-3xl font-heading font-bold text-neutral-900 mb-6">Shopping Cart</h1>
    <span class="text-sm text-neutral-600 mb-8 block">
        {{ cart_total_items }} item{{ cart_total_items|pluralize }} in your cart
    </span>

    {% if cart_items %}
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Cart Items -->
        <div class="lg:col-span-2 space-y-6">
            {% for item in cart_items %}
            <div class="bg-white border border-neutral-200 rounded-2xl p-6 flex gap-6 items-center">
                
                <!-- Image -->
                <div class="w-24 h-24 sm:w-32 sm:h-32 bg-neutral-100 rounded-xl flex items-center justify-center overflow-hidden">
                    {% if item.product.image %}
                        <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="w-full h-full object-cover">
                    {% else %}
                        <i class="fas fa-leaf text-primary text-3xl"></i>
                    {% endif %}
                </div>

                <!-- Product Details -->
                <div class="flex-1 flex flex-col justify-between">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-semibold text-neutral-900">{{ item.product.name }}</h3>
                            <p class="text-sm text-neutral-500">Price: {{ item.product.price }} XOF</p>
                        </div>
                        <div class="text-right">
                            <div class="text-primary font-semibold">{{ item.total_price }} XOF</div>
                            {% if user.is_authenticated %}
                            <form method="POST" action="{% url 'remove_cart_item' item.product.id %}">
                                {% csrf_token %}
                                <button type="submit" class="text-danger text-sm mt-2 hover:text-danger/80 flex items-center">
                                    <i class="fas fa-trash mr-1"></i> Remove
                                </button>
                            </form>
                            {% else %}
                            <button onclick="removeAnonymousItem({{ item.product.id }})" class="text-danger text-sm mt-2 hover:text-danger/80 flex items-center">
                                <i class="fas fa-trash mr-1"></i> Remove
                            </button>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Quantity -->
                    <div class="mt-4 flex items-center gap-4">
                        {% if user.is_authenticated %}
                        <form method="POST" action="{% url 'cart_update_item' item.product.id %}" class="flex items-center gap-2">
                            {% csrf_token %}
                            <button type="button" onclick="decrementQty({{ item.product.id }})" class="px-3 py-1 bg-neutral-100 rounded-lg hover:bg-neutral-200">-</button>
                            <input type="number" id="qty-{{ item.product.id }}" name="quantity" value="{{ item.quantity }}" min="1" max="{{ item.product.stock }}" class="w-16 text-center border rounded-lg">
                            <button type="button" onclick="incrementQty({{ item.product.id }}, {{ item.product.stock }})" class="px-3 py-1 bg-neutral-100 rounded-lg hover:bg-neutral-200">+</button>
                            <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary-600">Update</button>
                        </form>
                        {% else %}
                        <div class="flex items-center gap-2">
                            <button type="button" onclick="decrementQtyAnon({{ item.product.id }})" class="px-3 py-1 bg-neutral-100 rounded-lg hover:bg-neutral-200">-</button>
                            <input type="number" id="qty-{{ item.product.id }}" value="{{ item.quantity }}" min="1" max="{{ item.product.stock }}" class="w-16 text-center border rounded-lg" onchange="updateAnonymousQuantity({{ item.product.id }}, this.value)">
                            <button type="button" onclick="incrementQtyAnon({{ item.product.id }}, {{ item.product.stock }})" class="px-3 py-1 bg-neutral-100 rounded-lg hover:bg-neutral-200">+</button>
                        </div>
                        {% endif %}
                    </div>

                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Cart Summary -->
        <div class="lg:col-span-1 bg-white border border-neutral-200 rounded-2xl p-6 sticky top-24">
            <h2 class="text-xl font-semibold mb-4">Order Summary</h2>
            <div class="flex justify-between mb-2"><span>Subtotal</span><span>{{ cart_total_price }} XOF</span></div>
            <div class="flex justify-between mb-2"><span>Shipping</span><span>FREE</span></div>
            <div class="border-t pt-2 flex justify-between font-semibold"><span>Total</span><span>{{ cart_total_price }} XOF</span></div>

            <a href="{% url 'checkout' %}" class="block mt-6 w-full bg-primary text-white py-3 rounded-lg text-center hover:bg-primary-600">
                Proceed to Checkout
            </a>
        </div>
    </div>

    {% else %}
    <p class="text-center text-neutral-600 mt-16">Your cart is empty. <a href="/shop" class="text-primary hover:underline">Start shopping</a></p>
    {% endif %}
</div>

{% block extra_js %}
<script>
function incrementQty(pid, stock) {
    const input = document.getElementById(`qty-${pid}`);
    if(parseInt(input.value) < stock) input.value = parseInt(input.value)+1;
}
function decrementQty(pid) {
    const input = document.getElementById(`qty-${pid}`);
    if(parseInt(input.value) > 1) input.value = parseInt(input.value)-1;
}

function incrementQtyAnon(pid, stock){
    const input = document.getElementById(`qty-${pid}`);
    if(parseInt(input.value) < stock) input.value = parseInt(input.value)+1;
    updateAnonymousQuantity(pid, input.value);
}
function decrementQtyAnon(pid){
    const input = document.getElementById(`qty-${pid}`);
    if(parseInt(input.value) > 1) input.value = parseInt(input.value)-1;
    updateAnonymousQuantity(pid, input.value);
}

function removeAnonymousItem(productId) {
    fetch(`/cart/remove/${productId}/`).then(()=>location.reload());
}

function updateAnonymousQuantity(productId, qty) {
    fetch(`/cart/update/${productId}/`, {
        method: 'POST',
        headers: {'X-CSRFToken':'{{ csrf_token }}'},
        body: new URLSearchParams({'quantity': qty})
    }).then(()=>location.reload());
}
</script>
{% endblock %}

{% endblock %}